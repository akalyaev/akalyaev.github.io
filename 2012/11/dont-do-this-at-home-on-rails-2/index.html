<!DOCTYPE html>
<html lang="en-us">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    


    
        <meta name="twitter:card" content="summary"/>
    



<meta name="twitter:title" content="Don&#39;t do this at home on Rails #2"/>
<meta name="twitter:description" content="
Languages: Ruby
Difficulty: Easy


Intro

Now is the time to break down the next three examples of code that look
slightly chapped, and just beg to be retouched. Despite the apparent
complexity, by running a series of easy refactorings, we can significantly
improve the code: reduce the size, improve the readability and even
increase its speed. Who knows?

"/>



  	<meta property="og:title" content=" Don&#39;t do this at home on Rails #2 &middot;  Home on Rails" />
  	<meta property="og:site_name" content="Home on Rails" />
  	<meta property="og:url" content="http://homeonrails.com/2012/11/dont-do-this-at-home-on-rails-2/" />

    
  	<meta property="og:type" content="article" />

    <meta property="og:article:published_time" content="2012-11-10T00:00:00Z" />

    
    <meta property="og:article:tag" content="ruby" />
    
    <meta property="og:article:tag" content="ruby-on-rails" />
    
    <meta property="og:article:tag" content="refactoring" />
    
    

    <title>
       Don&#39;t do this at home on Rails #2 &middot;  Home on Rails
    </title>

    <meta name="description" content="Notes on software development, traveling and life" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="http://homeonrails.com/images/favicon.ico">
	  <link rel="apple-touch-icon" href="http://homeonrails.com/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="http://homeonrails.com/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="http://homeonrails.com/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />


    
      
          <link href="http://homeonrails.com/index.xml" rel="alternate" type="application/rss+xml" title="Home on Rails" />
      
      
    
    <meta name="generator" content="Hugo 0.18.1" />

    <link rel="canonical" href="http://homeonrails.com/2012/11/dont-do-this-at-home-on-rails-2/" />

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-35080566-1', 'auto');
      ga('send', 'pageview');

    </script>
    

    
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/solarized-dark.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
            
            <li class="nav-opened" role="presentation">
            	<a href="http://homeonrails.com/">Blog</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="http://homeonrails.com/about">About me</a>
            </li>
        
            <h3>Explore</h3>
            <li class="nav-opened" role="presentation">
            	<a href="http://homeonrails.com/most-popular-posts">Most popular posts</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://speakerdeck.com/akalyaev">Talks</a>
            </li>
        
            <h3>Follow Me</h3>
            <li class="nav-opened" role="presentation">
            	<a href="https://github.com/akalyaev">Github repos</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://twitter.com/AntonKalyaev">Twitter timeline</a>
            </li>
        
            <h3>Contact Me</h3>
            <li class="nav-opened" role="presentation">
            	<a href="http://www.linkedin.com/in/anton-kalyaev">LinkedIn</a>
            </li>
        
    </ul>
    
    
    <a class="subscribe-button icon-feed" href="http://homeonrails.com/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">




<header class="main-header post-head no-cover">
  <nav class="main-nav clearfix">


  
      <a class="blog-logo" href="http://homeonrails.com/"><img src="http://homeonrails.com/images/logo.png" alt="Home" /></a>
  
  
      <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">Don&#39;t do this at home on Rails #2</h1>
        <small></small>

        <section class="post-meta">
        
          <time class="post-date" datetime="2012-11-10T00:00:00Z">
            Nov 10, 2012
          </time>
        
         
          <span class="post-tag small"><a href="http://homeonrails.com/tags/ruby/">#ruby</a></span>
         
          <span class="post-tag small"><a href="http://homeonrails.com/tags/ruby-on-rails/">#ruby-on-rails</a></span>
         
          <span class="post-tag small"><a href="http://homeonrails.com/tags/refactoring/">#refactoring</a></span>
         
        </section>
    </header>

    <section class="post-content">
      <ul>
<li>Languages: Ruby</li>
<li>Difficulty: <span class="label label-success">Easy</span></li>
</ul>

<h2 id="intro">Intro</h2>

<p>Now is the time to break down the next three examples of code that look
slightly chapped, and just beg to be retouched. Despite the apparent
complexity, by running a series of easy refactorings, we can significantly
improve the code: reduce the size, improve the readability and even
increase its speed. Who knows?</p>

<p></p>

<p>Well, let&rsquo;s start.</p>

<h3 id="1-prefer-time-current-over-time-zone-now-or-time-zone">#1 - prefer Time.current over Time.zone.now or Time.zone</h3>

<p>Very often I see a code like this:</p>

<pre><code class="language-ruby">if schedulled_at &gt; Time.zone.now
  ...
end
</code></pre>

<p>And there is nothing wrong with it :) Seriously. But what if we have not set
the time zone? Most likely we&rsquo;ll get an error. Just recently I came across a
method that does this check for us.</p>

<p><a href="http://apidock.com/rails/Time/current/class">Time.current</a> - returns
<code>Time.zone.now</code> if the <code>Time.zone</code> or <code>config.time_zone</code> set,
otherwise just returns <code>Time.now</code>.</p>

<pre><code class="language-ruby">if schedulled_at &gt; Time.current
  ...
end
</code></pre>

<h3 id="2-avoid-using-before-filter">#2 - Avoid using <code>before_filter</code></h3>

<p><code>before_filter</code> is used inside controllers to execute any code before any action
will be executed. This allows us to avoid duplicating code. But, like any tool,
it can be used &ldquo;in the wrong way&rdquo;.</p>

<pre><code class="language-ruby">class SubscribesController &lt; ApplicationController
  before_filter :load_subscribe, only: [:show, :destroy]

  def index
    @subscribes = Subscribe.all
  end

  def show
  end

  def destroy
    @subscribe.destroy
    redirect_to :root
  end

  private

    def load_subscribe
      @subscribe = Subscribe.find_by_name(params[:id]) || raise(ActiveRecord::RecordNotFound)
    end
end
</code></pre>

<p>I do not mind eliminating duplication, especially when the private method below
does consist of 40 lines, for example. I just think, logic should be more explicit
here. Otherwise, to understand what makes a particular action, the programmer
must first look at all before filters, then look at the methods that are
called by these filters and only then he or she comes to the action itself. This makes
the application logic confusing and difficult to understand.</p>

<p>Before filters are really helpful in some cases. For example, when we need to check
whether the user is authorized or log each request.</p>

<pre><code class="language-ruby">class SubscribesController &lt; ApplicationController
  def index
    @subscribes = Subscribe.all
  end

  def show
    load_subscribe
  end

  def destroy
    load_subscribe
    @subscribe.destroy
    redirect_to :root
  end

  private

  def load_subscribe
    @subscribe = Subscribe.find_by_name!(params[:id])
  end
end
</code></pre>

<p>When you look at each action it doesn&rsquo;t seem like the instance variables appear
magically. As the capabilities of a controller increases in size it becomes more
difficult to see the &ldquo;magic&rdquo; of a before filter hidden somewhere in the app
and the explicitness of method calling becomes very helpful.</p>

<p>Note that I added <code>!</code> sign to the <code>find_by_name</code> method, which now throws an exception if the
corresponding record is not found. Next, I would probably get rid of the private
method, since it consists only of one line.</p>

<h3 id="3-use-powerful-enumerable-methods-example-with-select">#3 - Use powerful <code>Enumerable</code> methods (example with <code>select</code>)</h3>

<p>Module <a href="http://ruby-doc.org/core-1.9.3/Enumerable.html">Enumerable</a> provides a
variety of methods for manipulating, traversing and searching though a
collection. It is very hard to remember them all, but that is not necessary.
What is required of us, is to simplify code by maximum.</p>

<p>Now I will show you two main sources that help me every day:
- <a href="http://apidock.com/">APIdock</a>
- <a href="http://ruby-doc.org/core-1.9.3/">Ruby 1.9.3 Doc</a></p>

<pre><code class="language-ruby"># before
@groups = Group.all.find_all { |g| g.admin?(current_user) }
@projects = Project.all.find_all { |p| p.admin?(current_user) }

# after
@groups = Group.select { |g| g.admin?(current_user) }
@projects = Project.select { |p| p.admin?(current_user) }
</code></pre>

<p>As you can see, the code has not changed much.
But, using such a bricks, we can build really powerful self-documenting code.</p>

<p>After all, this leads to a reducing of complexity, which makes the code
transparent and flexible. As a result, we can do refactor
it without any problems.</p>

<p>And that&rsquo;s all for today folks!</p>

<h2 id="follow-up">Follow up</h2>

<ul>
<li><a href="http://homeonrails.com/2013/01/dont-do-this-at-home-on-rails-3">Don&rsquo;t do this at home on Rails #3</a></li>
</ul>
    </section>


  <footer class="post-footer">


    
    <figure class="author-image">
        <a class="img" href="http://homeonrails.com/" style="background-image: url(http://homeonrails.com/images/logo.png)"><span class="hidden">Anton Kalyaev's Picture</span></a>
    </figure>
    

    





<section class="author">
  <h4><a href="http://homeonrails.com/">Anton Kalyaev</a></h4>
  
  <p>Software engineer, blogger, public speaker, traveler</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Ulyanovsk, Russia</span>
    <span class="author-link icon-link"><a href="http://homeonrails.com">http://homeonrails.com</a></span>
  </div>
</section>



    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=Don%27t%20do%20this%20at%20home%20on%20Rails%20%232&nbsp;-&nbsp;Home%20on%20Rails&amp;url=http%3a%2f%2fhomeonrails.com%2f2012%2f11%2fdont-do-this-at-home-on-rails-2%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fhomeonrails.com%2f2012%2f11%2fdont-do-this-at-home-on-rails-2%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-pinterest" style="font-size: 1.4em" href="http://pinterest.com/pin/create/button/?url=http%3a%2f%2fhomeonrails.com%2f2012%2f11%2fdont-do-this-at-home-on-rails-2%2f&amp;description=Don%27t%20do%20this%20at%20home%20on%20Rails%20%232"
      onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
      <span class="hidden">Pinterest</span>
  </a>
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=http%3a%2f%2fhomeonrails.com%2f2012%2f11%2fdont-do-this-at-home-on-rails-2%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



    

<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'homeonrails';
  var disqus_url = 'http:\/\/homeonrails.com\/2012\/11\/dont-do-this-at-home-on-rails-2\/';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




  </footer>
</article>

</main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Home on Rails</a> All rights reserved - 2017</section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="http://homeonrails.com/js/jquery.js"></script>
    <script type="text/javascript" src="http://homeonrails.com/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="http://homeonrails.com/js/index.js"></script>
    
</body>
</html>

